trigger:
  branches:
    include:
      - main
      - release/*

# Runs validation for PRs, but skip_deploy condition handles the rest
pr:
  branches:
    include:
      - main
      - develop # Assuming develop is used for PRs

variables:
  acrName: cicdRegistry111
  imageName: webapp
  # Requirement: Branch name + Build ID
  tag: '$(Build.SourceBranchName)-$(Build.BuildId)'

stages:
- stage: Build
  displayName: Build Stage
  jobs:
  - job: BuildAndTest
    pool:
      vmImage: ubuntu-latest
    steps:
    # Requirement: Restore, Build, Test .NET
    - task: DotNetCoreCLI@2
      inputs:
        command: 'test'
        projects: '**/*.csproj'
    
    - task: Docker@2
      displayName: Build and Push
      inputs:
        containerRegistry: acr-connection
        repository: $(imageName)
        command: buildAndPush
        tags: |
          $(tag)
    
    # Requirement: Cleanly separate/reusable (Publish manifests for deploy stages)
    - publish: k8s
      artifact: manifests

# REUSABLE DEPLOYMENT LOGIC (Simplified for this example)
- stage: DeployDev
  displayName: Deploy to Dev
  # Requirement: PRs must not deploy
  condition: and(succeeded(), ne(variables['Build.Reason'], 'PullRequest'))
  jobs:
  - deployment: Dev
    environment: 'Dev' # Automatically deploys
    pool:
      vmImage: ubuntu-latest
    strategy:
      runOnce:
        deploy:
          steps:
          - download: current
            artifact: manifests
          - task: KubernetesManifest@0
            inputs:
              action: deploy
              manifests: '$(Pipeline.Workspace)/manifests/*.yaml'
              containers: 'cicdRegistry111.azurecr.io/$(imageName):$(tag)'

- stage: DeployProd
  displayName: Deploy to Prod
  dependsOn: DeployDev
  # Requirement: PRs must not deploy
  condition: and(succeeded(), ne(variables['Build.Reason'], 'PullRequest'))
  jobs:
  - deployment: Prod
    environment: 'Prod' # Requirement: Use Environment for Approvals
    pool:
      vmImage: ubuntu-latest
    strategy:
      runOnce:
        deploy:
          steps:
          - download: current
            artifact: manifests
          - task: KubernetesManifest@0
            inputs:
              action: deploy
              manifests: '$(Pipeline.Workspace)/manifests/*.yaml'
              containers: 'cicdRegistry111.azurecr.io/$(imageName):$(tag)'